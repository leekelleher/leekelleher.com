WritePath: tag\umbraco\feed\index.xml
---
@using System.ServiceModel.Syndication;
@using System.IO;
@using System.Xml;
@using AngleSharp;
@using AngleSharp.Parser.Html;
@{
	Layout = string.Empty;

	var tag = "Umbraco";
	var documentsByTag = Documents
		.WhereContainsKey("tags")
		.WhereContainsKey("date")
		.ToLookupMany<string>("tags", StringComparer.CurrentCultureIgnoreCase);
	
	var baseUri = new Uri("https://leekelleher.com");
	var feedTitle = "Lee Kelleher - Umbraco";
	var feedDescription = "Latest Umbraco posts by Lee Kelleher - Umbraco Consultant";
	var feed = new SyndicationFeed(feedTitle, feedDescription, baseUri)
	{
		Generator = "Wyam",
		ImageUrl = new Uri("https://leekelleher.com/assets/img/northbynorthwest_300x300.jpg"),
		Items = documentsByTag[tag]
			.WhereContainsKey("date")
			.Where(x => x.ContainsKey("date"))
			.OrderByDescending(x => x.Get<DateTime>("date"))
			.Take(10)
			.Select(x => {
				var postTitle = x.String("title");
				var postContent = x.String("PostContent", x.String("Excerpt"));
				var builder = new UriBuilder(Context.GetLink(x, true)) { Scheme = Uri.UriSchemeHttps, Port = -1 };
				var postUri = builder.Uri;
				
				return new SyndicationItem(postTitle, postContent, postUri)
				{
					Content = new TextSyndicationContent(postContent, TextSyndicationContentKind.Html),
					Id = postUri.ToString(),
					PublishDate = x.Get<DateTime>("date"),
				};
			}),
		Language = "en-GB",
		LastUpdatedTime = DateTime.UtcNow
	};

	feed.Links.Add(new SyndicationLink(new Uri(baseUri, "tag/umbraco/feed/")) { RelationshipType = "self" });

	using (var writer = new XmlTextWriter(Output))
	{
		new Rss20FeedFormatter(feed).WriteTo(writer);
	}
}
